# Kernel Internal

- virtual filesystem (VFS)
- the page cache
- page writeback
- I/O scheduler

## 虚拟文件系统

VFS也被称为虚拟文件交换，这是一种抽象机制，它有允许你和调用文件系统函数，操作文件系统数据而不用关心具体使用的文件系统类型。

这种抽系机制由“通用文件模型”提供。

## Page Cache

页缓存是一种将访问数据从磁盘上的文件系统存储到内存中的机制。

在内存中存储被请求的数据，可以让内核实现在随后的请求中从内存中取得相同数据，从而避免重复的磁盘访问。

查找顺序：

1. 内核首先从页缓存中查找文件系统数据。
2. 如果缓存中找不到，才会去磁盘中寻。

读写顺序：

1. 数据中任何项在第一次读取时都会被转换到页缓存中
2. 然后从缓存中将数据返回给应用
3. 如果相同的数据被再次读取，则直接从缓冲返回

Linux的页缓存是动态大小的，I/O操作会将越来越多的数据转换到内存，如果页缓存把所剩余的内存消耗完的话，它会被“修剪”。“修剪”操作将会释放最少使用的页以腾出更多的空间来保证数据存储中。

更加有意义的做法是“交换”第使用频率的进程内存页面到磁盘，这样可以在需要时重新读取到内存中。

swap和cache的平衡可以通过/proc/sys/vm/swappiness来调整。该虚拟文件的值从0到100，默认为60。值越大页缓存占用的内存也越多。

## Page Writeback

内核使用缓冲(buffer)实现延时写操作。

进程发起写请求，数据复制到缓冲中，而此时的缓冲会被打上“脏(dirty)”标记，以说明内存中的数据比磁盘上的更新。

dirty buffers需要提交回磁盘，然后将内存中的数据同步到磁盘，就被称为“回写”。

使用场景：

- 当内存收缩至配置阈值之下时，脏缓冲就被回写到磁盘，而被清空的缓冲就可以移除了，以释放内存。

- 当脏缓冲的时间超过了配置阈值时，缓冲就被回写到磁盘。以防止数据无限期地保留在脏缓冲中。

回写实际上是由内核中的一群称作“冲刷器”的线程来完成。当遇到前两种情况时，冲刷器线程醒来，然后开始把脏缓冲提交到磁盘，直到上述两种条件都不为真时。
